---
title: "Synthèse conjoncturelle des comptes des secteurs institutionnels"
author: '@statjunior'
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    template: eisvogel.tex
    keep_tex: yes
  word_document: default
subtitle: Résultats détaillés des *Comptes Nationaux Trimestriels* au 2e trimestre
  2023.
titlepage: yes
titlepage-color: 9e8b10
titlepage-text-color: FFFFFF
disable-header-and-footer: yes
logo: logo.pdf
logo-width: 200
lang: "fr-FR"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
list(rm=ls())
library(insee)
library(plyr)
library(dplyr)
library(ggplot2)
library(readxl) 
library(writexl)
library(tsibble)
library(tibble)
library(janitor)
library(tsbox)
library(knitr)
library(tempdisagg)
library(labelled)
library(stringr)
library(Hmisc)
library(hrbrthemes)
library(lubridate)
library(conflicted)
library(base)
library(tidyr)
library(cowplot)
library(plotly)
library(lubridate)

conflict_prefer("rename", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("arrange", "dplyr")
conflict_prefer("replace", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("summarise", "dplyr")
conflict_prefer("relocate", "dplyr")
conflict_prefer("select", "dplyr")

setwd <- setwd("C:/Users/gasto/Documents/GitHub/Statjunior/Conjoncture - comptes trimestriels/")
getwd()

date_max_compte_def <- "2023-01-01"
date_def_litt <- "1er trimestre 2023"
date_def_trim <- "T1-2023"
```

# Présentation

Ce rapport *RMarkdown* présente les résultats détaillés des comptes des secteurs institutionnels (ménages, entreprises, administrations publiques, reste du monde) au `r date_def_litt`. 

Le rapport présente successivement les grands indicateurs macroéconomiques à retenir pour chaque agent économique. 

Pour les ménages, on présente d'abord le revenu disponible brut et les prix à la consommation en comptabilité nationale afin d'en déduire le pouvoir d'achat des ménages. Le pouvoir d'achat des ménages est un indicateur macroéconomique qui ne tient pas compte de la taille des ménages et des économies d'échelle. C'est pourquoi on présente également le pouvoir d'achat par unité de consommation (UC). Le pouvoir d'achat des ménages par UC tient compte de la croissance de la population et des économies ou d'échelle liées à la vie sous un même toit. Enfin, on présente les contributions à l'évolution du pouvoir d'achat afin de distinguer une variation liée aux revenus du travail, à la fiscalité, aux prestations ou aux revenus du capital. 

Pour les entreprises, on s'intéresse principalement aux sociétés non financières (SNF). On présente tout d'abord leur taux de marge et leur taux d'investissement sur longue période. Puis, on décompose les contributions de l'évolution du taux de marge depuis 2018 (on retient l'année 2018 car l'année 2019 est biaisée par la baisse de CICE). 

On s'intéresse ensuite aux comptes des administrations publiques (APU). On présente l'évolution des recettes et des dépenses publiques sur longue période. On distingue ensuite l'évolution des dépenses par grande composante. Enfin, on présente l'évolution du déficit public sur longue période ainsi que la charge d'intérêt de la dette. 

Enfin, on présente la situation de financement de l'économie française vis à vis du reste du monde. 

Ce rapport a été compilé automatiquement avec le logiciel ``R``, le `r format(Sys.time(), '%d %B %Y à %H heures et %M minutes')`. Les potentielles erreurs présentes dans ce document relèvent uniquement de la responsabilité de Statjunior.

Le code source permettant de générer ce document est disponible sur Git [en cliquant ici](https://github.com/statjunior/Statjunior/tree/main/Conjoncture%20-%20comptes%20trimestriels/).


```{r, echo=FALSE, message=FALSE, results='hide'}
############################### 0) PARAMETRES A FIXER AVANT DE FAIRE TOURNER LE CODE
#Définir la date (YY-MM-DD) du dernier point de la Résultats détaillés des comptes trimestriels (1er trimestre 2023)
date_max_compte_prov <- "2023-01-01"
#Définir la date (YY-MM-DD) du dernier point de l'estimation définitive des comptes trimestriels (1er trimestre 2023)
date_max_compte_def <- "2023-01-01"


####Date de la base 100 pour les graphiques en niveau 
scale_2019t4 <- function(x, na.rm = FALSE) x/x[rdb_menages[,1] == "2019-10-01"]*100
scale_2018t4 <- function(x, na.rm = FALSE) x/x[cnt_cb_complet[,1] == "2018-10-01"]*100
scale_2000t1 <- function(x, na.rm = FALSE) x/x[rdb_menages[,1] == "2000-01-01"]*100

# Décomposition du taux de marge des sociétés non financières, 4e trimestre 2022, Comptes définitifs :https://www.insee.fr/fr/statistiques/6960363?sommaire=6795771#titre-bloc-7

#Télécharger et charger le fichier de décomposition des taux de marge des SNF 
file_decompo_tx_marge_snf <- "data/t_txmargesnf_val.xls"

####Import des excels précédemment téléchargés à la main...

#Décomposition du taux de marge des SNF 
decompo_tm_snf <- read_excel(file_decompo_tx_marge_snf, 
                            sheet = "Evolutions",skip = 5) |>
  rename("DATE" = "...1", "tx_marge" = "...2", "var_tx_marge" = "...3", "contrib_productivite" = 4, 
         "contrib_sal_reel" = 5, "contrib_cot_soc" = 6, "contrib_terme_echange" = 7, "contrib_autres_facteurs" = 8) |>
  filter(!is.na(tx_marge)) 
decompo_tm_snf$DATE <- str_replace(decompo_tm_snf$DATE,"T1", "-01-01")
decompo_tm_snf$DATE <- str_replace(decompo_tm_snf$DATE,"T2", "-04-01")
decompo_tm_snf$DATE <- str_replace(decompo_tm_snf$DATE,"T3", "-07-01")
decompo_tm_snf$DATE <- str_replace(decompo_tm_snf$DATE,"T4", "-10-01")
decompo_tm_snf$DATE <- as.Date(decompo_tm_snf$DATE)


######################################### 1) Téléchargement des séries depuis le package Insee 
#Contributions du PIB 
list_idbank_pib = 
  get_idbank_list("CNT-2014-PIB-EQB-RF") 

#Extraction des numéros de séries 
pib = list_idbank_pib %>% pull(idbank)
#############################Décomposition du PIB par composante (C+FBCF+X-M+VS)
pib_2014 = 
  get_insee_idbank(pib) %>% 
  split_title() 

pib_2014_bis <- pib_2014 |>
  mutate(TITLE_FR1 = case_when(
    TITLE_FR1 == "Produit intérieur brut total"~"pib_tot",
    TITLE_FR1 == "Dépenses de consommation totales"~"conso_tot", 
    TITLE_FR1 == "Dépenses de consommation totales"~"conso_tot",
    TITLE_FR1 == "Exportations"~"export_tot",
    TITLE_FR1 == "FBCF de l'ensemble des secteurs institutionnels"~"fbcf_tot",
    TITLE_FR1 == "FBCF Total"~"fbcf_tot", 
    TITLE_FR1 == "Importations"~"import_tot",
    TITLE_FR1 == "Variations de stocks"~"vs_tot",
    TITLE_FR1 =="Variation des stocks"~"vs_tot",
    TITLE_FR1 == "Dépenses de consommation collective des APU"~"conso_apu_col",
    TITLE_FR1 == "Dépenses de consommation des APU"~"conso_apu",
    TITLE_FR1 == "Dépenses de consommation des ISBLSM"~"conso_isblsm",
    TITLE_FR1 == "Dépenses de consommation des ménages"~"conso_men",
    TITLE_FR1 == "Dépenses de consommation individualisable des APU"~"conso_apu_ind",
    TITLE_FR1 == "Dépenses de consommation des APU collectives"~"conso_apu_col",
    TITLE_FR1 == "FBCF des administrations publiques"~"fbcf_apu",
    TITLE_FR1 == "FBCF des APU"~"fbcf_apu",
    TITLE_FR1 == "FBCF des entreprises financières"~"fbcf_ef",
    TITLE_FR1 == "FBCF des entreprises non financières"~"fbcf_enf",
    TITLE_FR1 == "FBCF des ISBLSM"~"fbcf_isblsm",
    TITLE_FR1 == "FBCF des ménages"~"fbcf_men",
    TITLE_FR1 == "FBCF des sociétés financières"~"fbcf_sf"
        ), 

    TITLE_FR2 = case_when(
      TITLE_FR2=="Contribution à l'évolution du PIB"~"contrib_pib",
    TITLE_FR2 =="Évolution du Produit intérieur brut total"~"croissance_trim_pib",
    TITLE_FR2 =="Valeur aux prix courants"~"val",
    TITLE_FR2 =="Volume aux prix de l'année précédente chaînés"~"vol"
        ),

    TITLE_FR3 = case_when(
      TITLE_FR3=="Valeur aux prix courants"~"val",
      TITLE_FR3 =="Volume aux prix de l'année précédente chaînés"~"vol"
          )) |>
  
  filter(!is.na(TITLE_FR1)) |>
  mutate(TITLE_FR3 = ifelse(is.na(TITLE_FR3) & (TITLE_FR2 == "val" | TITLE_FR2 == "vol"), TITLE_FR2, TITLE_FR3))

###############################Calcul des contributions trimestrielles au PIB par composante
contrib_pib_eer <- filter(pib_2014_bis, TITLE_FR2 =="contrib_pib") |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE) |>
  mutate(croissance_pib = conso_men+conso_apu_ind+conso_apu_col+conso_isblsm+fbcf_tot+export_tot+vs_tot-import_tot) |>
  select(DATE, croissance_pib, conso_men,conso_apu_ind,conso_apu_col,conso_isblsm,fbcf_tot,export_tot,vs_tot,import_tot) |>
  mutate(conso = conso_men+conso_apu_ind+conso_apu_col + conso_isblsm) |>
  select(-conso_men,-conso_apu_ind,-conso_apu_col,-conso_isblsm) |>
  mutate(import_tot=-import_tot) |>
  pivot_longer(cols=c(3:7), names_to = "Composante", values_to = "value") |>
  mutate(Composante = case_when(
    Composante=="conso"~"Consommation",
    Composante =="export_tot"~"Export",
    Composante =="import_tot"~"Import",
    Composante =="fbcf_tot"~"Investissement",
    Composante =="vs_tot"~"Variations de stocks"
  ))

contrib_pib_eer$Composante<- as.factor(contrib_pib_eer$Composante)


####################################Calcul des déflateurs des composantes du PIB 
pib_eer <- filter(pib_2014_bis, TITLE_FR2 !="contrib_pib" | is.na(TITLE_FR2)) |>
  select(-TITLE_FR2) |>
  mutate(titre = paste0(TITLE_FR1,"_", TITLE_FR3)) |>
  pivot_wider(names_from = titre, values_from = OBS_VALUE, id_cols = DATE) |>
  mutate(deflateur_pib = pib_tot_val/pib_tot_vol*100) |>
  mutate(deflateur_conso_men = conso_men_val/conso_men_vol*100) |>
  mutate(deflateur_fbcf = fbcf_tot_val/fbcf_tot_vol*100) |>
  mutate(deflateur_export = export_tot_val/export_tot_vol*100) |>
  mutate(deflateur_import = import_tot_val/import_tot_vol*100) |>
  arrange(DATE) |>
  mutate(gliss_annuel_deflateur_pib = ((deflateur_pib/lag(deflateur_pib, 4))-1)*100) |>
  mutate(gliss_annuel_deflateur_conso_men = ((deflateur_conso_men/lag(deflateur_conso_men, 4))-1)*100) |>
  mutate(gliss_annuel_deflateur_fbcf = ((deflateur_fbcf/lag(deflateur_fbcf, 4))-1)*100) |>
  mutate(gliss_annuel_deflateur_export = ((deflateur_export/lag(deflateur_export, 4))-1)*100) |>
  mutate(gliss_annuel_deflateur_import = ((deflateur_import/lag(deflateur_import, 4))-1)*100) 


####Bien télécharger Pouvoir d'achat et ratio du compte des ménages: 
#https://www.insee.fr/fr/statistiques/6960365?sommaire=6795771 
file_rdb_uc <- "data/t_pouvachat_val.xls"
rdb_uc <- read_excel(file_rdb_uc,  sheet = "Evolutions", skip = 7) |>
   select("...1", "B6/UC", "(B6/P3prix)/UC") |>
   rename(DATE = "...1", rd_uc = "B6/UC", pa_rdb_uc = "(B6/P3prix)/UC")
rdb_uc$DATE <-   str_replace(rdb_uc$DATE,"T1", "-01-01")
rdb_uc$DATE <-   str_replace(rdb_uc$DATE,"T2", "-04-01")
rdb_uc$DATE <-   str_replace(rdb_uc$DATE,"T3", "-07-01")
rdb_uc$DATE <-   str_replace(rdb_uc$DATE,"T4", "-10-01")
rdb_uc$DATE <- as.Date(rdb_uc$DATE)
rdb_uc <- filter(rdb_uc, DATE >= as.Date("1978-01-01")) |>
   mutate(cum_rdb_uc = ifelse(DATE == as.Date('1978-01-01'), 100, NA)) |>
   mutate(cum_pa_uc = ifelse(DATE == as.Date('1978-01-01'), 100, NA)) |>
   arrange(DATE)

i <-2
while(i <=nrow(rdb_uc)){
   rdb_uc[i, "cum_rdb_uc"] <- rdb_uc[i-1, "cum_rdb_uc"]*(1+(rdb_uc[i, "rd_uc"]/100))
   i <- i+1
 }
i <-2
while(i <=nrow(rdb_uc)){
   rdb_uc[i, "cum_pa_uc"] <- rdb_uc[i-1, "cum_pa_uc"]*(1+(rdb_uc[i, "pa_rdb_uc"]/100))
   i <- i+1
}
rdb_uc <- select(rdb_uc, -rd_uc, -pa_rdb_uc)

####A faire : 
#capacité besoin de financement vis a vis du RDM en % PIB
#taux de marge décomposé par secteur depuis 2018 
#evolution du PIB, PA et PA par UC sur longue période et en base 100 en 2019
#taux d'épargne 

list_idbank_csi = 
  get_idbank_list("CNT-2014-CSI") 

csi = list_idbank_csi %>% pull(idbank)

csi_2014 = 
  get_insee_idbank(csi) %>% 
  split_title() 

liste_t1 <- distinct(csi_2014, TITLE_FR1)



```


# Compte des ménages 
## Revenu disponible brut et pouvoir d'achat depuis 2000
```{r,fig.dim = c(14, 16)}
#########################Pouvoir d'achat des ménages de LT par rapport au PIB 
rdb_menages <- filter(csi_2014, TITLE_FR1 == "Revenu disponible brut des ménages (y compris les entreprises individuelles)") |>
  select(DATE, OBS_VALUE) |>
  rename(rdbrut_menages = OBS_VALUE)
pib_deflateur_conso_menages <- select(pib_eer, DATE, pib_tot_vol, deflateur_conso_men, pib_tot_val) 
rdb_menages <- left_join(rdb_menages, pib_deflateur_conso_menages, by = "DATE")
rdb_menages <- left_join(rdb_menages, rdb_uc, by = "DATE")

rdb_menages_2000 <- mutate_at(rdb_menages, vars(2:4), scale_2000t1)
rdb_menages_2000 <- mutate_at(rdb_menages, vars(-1), scale_2000t1)
rdb_menages_2019 <- mutate_at(rdb_menages, vars(-1), scale_2019t4)

rdb_menages_2000 <- mutate(rdb_menages_2000,pa_menages = rdbrut_menages/deflateur_conso_men*100)
rdb_menages_2019 <- mutate(rdb_menages_2019,pa_menages = rdbrut_menages/deflateur_conso_men*100)

valeur2000 <- rdb_menages_2000 |> filter(DATE == max(DATE)) |>
  pull(rdbrut_menages) |> round(digits = 1)
valeur2000 <- valeur2000 - 100

valeurpa2000 <- rdb_menages_2000 |> filter(DATE == max(DATE)) |>
  pull(pa_menages) |> round(digits = 1)
valeurpa2000 <- valeurpa2000 - 100

plot_rdb_deflateur2000 <- ggplot(data = rdb_menages_2000,
                                   aes(x = DATE)) +
  geom_line(aes(y = rdbrut_menages, color = "Revenu Disponible Brut"), size = 1.3) + 
  geom_line(aes(y = cum_rdb_uc, color = "RDB par UC"), size = 1.1, linetype = "dashed") + 
  geom_line(aes(y = deflateur_conso_men, color = "Prix à la conso (compta. nat.)"), size = 1.1) + 
  labs(title = "Revenu Disponible Brut et Prix à la consommation depuis 2000", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le Revenu disponible brut des ménages augmente de ", valeur2000, " points par rapport au 1er trimestre 2000.  \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       y = "Base 100 au 1er trimestre 2000", x = "Année") +
  scale_x_date(limits = as.Date(c("2000-01-01", NA))) + 
  scale_color_manual(values = c("Revenu Disponible Brut"="#00B8E7","RDB par UC"="purple", "Prix à la conso (compta. nat.)" = "red"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))+
  ylim(98,NA) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))


plot_rdb_menages2000 <-ggplot(data = rdb_menages_2000,
                             aes(x = DATE)) +
  geom_line(aes(y = pa_menages, color = "Pouvoir d'achat du RDB"), size = 1.3) + 
  geom_line(aes(y = cum_pa_uc, color = "Pouvoir d'achat du RDB par UC"), size = 1.1, linetype = "dashed") + 
  geom_line(aes(y = pib_tot_vol, color = "PIB en volume"), size = 1.1) + 
  labs(title = "PIB et pouvoir d'achat du Revenu Disponible Brut (RDB) depuis 2000", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le pouvoir d'achat du RDB des ménages augmente de ", valeurpa2000, " points par rapport au 1er trimestre 2000.  \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"), 
       y = "Base 100 au 1er trimestre 2000", x = "Année") +
  scale_x_date(limits = as.Date(c("2000-01-01", NA))) + 
  scale_color_manual(values = c("Pouvoir d'achat du RDB"="#00B8E7","Pouvoir d'achat du RDB par UC" = "purple", "PIB en volume" = "orange"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))+ 
  ylim(98,NA) +
  guides(color=guide_legend(nrow=2, byrow=TRUE)) 


plot_pa_men2000 <- plot_grid(plot_rdb_deflateur2000, plot_rdb_menages2000, ncol = 1, nrow = 2)
print(plot_pa_men2000)
rm(valeur2000, valeurpa2000)
```


## Revenu disponible brut et pouvoir d'achat depuis 2019
```{r,fig.dim = c(14, 16)}
valeur2019 <- rdb_menages_2019 |>
  filter(DATE == max(DATE)) |> pull(rdbrut_menages) |>
  round(digits = 1)
valeur2019 <- valeur2019 - 100
valeurpa2019 <- rdb_menages_2019 |>
  filter(DATE == max(DATE)) |> pull(pa_menages) |>
  round(digits = 1)
valeurpa2019 <- valeurpa2019 - 100
valeurpa2019 <- round(valeurpa2019, digits =1)
valeurpauc2019 <- rdb_menages_2019 |>
  filter(DATE == max(DATE)) |> pull(cum_pa_uc) |>
  round(digits = 1)
valeurpauc2019 <- valeurpauc2019 - 100
valeurpauc2019 <- round(valeurpauc2019, digits =1)

plot_rdb_deflateur2019 <- ggplot(data = rdb_menages_2019,
                                 aes(x = DATE)) +
  geom_line(aes(y = rdbrut_menages, color = "Revenu Disponible Brut"), size = 1.3) + 
  geom_line(aes(y = cum_rdb_uc, color = "RDB par UC"), size = 1.1, linetype = "dashed") + 
  geom_line(aes(y = deflateur_conso_men, color = "Prix à la conso (compta. nat.)"), size = 1.1) + 
  labs(title = "Revenu Disponible Brut et Prix à la consommation depuis 2019", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le Revenu disponible brut des ménages augmente de ", valeur2019, " points par rapport au 4e trimestre 2019.  \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"), 

       y = "Base 100 au 4e trimestre 2019", x = "Année") +
  scale_x_date(limits = as.Date(c("2019-10-01", NA))) + 
  scale_color_manual(values = c("Revenu Disponible Brut"="#00B8E7","RDB par UC"="purple", "Prix à la conso (compta. nat.)" = "red"))+
 theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) + 
  ylim(95,NA) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))


plot_rdb_menages2019 <-ggplot(data = rdb_menages_2019,
                              aes(x = DATE)) +
  geom_line(aes(y = pa_menages, color = "Pouvoir d'achat du RDB"), size = 1.3) + 
  geom_line(aes(y = cum_pa_uc, color = "Pouvoir d'achat du RDB par UC"), size = 1.1, linetype = "dashed") + 
  geom_line(aes(y = pib_tot_vol, color = "PIB en volume"), size = 1.1) + 
  labs(title = "PIB et pouvoir d'achat du Revenu Disponible Brut (RDB) depuis 2019", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le pouvoir d'achat du RDB des ménages ", ifelse(valeurpa2019>0, "augmente", "recule")," de ", valeurpa2019, " points par rapport au 4e trimestre 2019. \nLecture: Par unité de consommation, le pouvoir d'achat du RDB des ménages ",ifelse(valeurpauc2019>0, "augmente", "recule")," de ", valeurpauc2019, " points par rapport au 4e trimestre 2019. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
       y = "Base 100 au 4e trimestre 2019", x = "Année") +
  scale_x_date(limits = as.Date(c("2019-10-01", NA))) + 
  scale_color_manual(values = c("Pouvoir d'achat du RDB"="#00B8E7","Pouvoir d'achat du RDB par UC" = "purple", "PIB en volume" = "orange"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) + 
  ylim(80,NA) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))

plot_pamen2019 <- plot_grid(plot_rdb_deflateur2019, plot_rdb_menages2019, ncol = 1, nrow = 2)
print(plot_pamen2019)
rm(valeur2019, valeurpa2019)

```


## Décomposition de l'évolution du pouvoir d'achat des ménages depuis 2019
```{r,fig.dim = c(14, 10)}
####Contribution au pouvoir d'achat 
decompo_rdb_menages <- filter(csi_2014, TITLE_FR1 == "Excédent brut d'exploitation des ménages hors EI (y compris revenus mixtes)" |
                                TITLE_FR1 == "Excédent brut d'exploitation des entrepreneurs individuels (y compris revenus mixtes)" |
                                TITLE_FR1 =="Masse salariale reçue par les ménages (y compris les entreprises individuelles)" |
                              TITLE_FR1 =="Cotisations sociales employeurs reçues par les ménages (y compris les entreprises individuelles)" | 
                                TITLE_FR1 =="Cotisations imputées reçues par les ménages (y compris les entreprises individuelles)" |
                                TITLE_FR1 == "Intérêts reçus par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 == "Dividendes reçus par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 == "Revenus de la propriété attribués aux assurés reçus par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 == "Loyers des terrains et gisements reçus par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 == "Intérêts versés par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 == "Loyers des terrains et gisements versés par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Prestations de sécurité sociale en espèces reçues par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Autres prestations d'assurance sociale reçues par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Prestations d'assistance sociale en espèces reçues par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Indemnités d'assurance-dommage reçues par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Transferts courants divers reçus par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Impôts sur le revenu versés par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Autres impôts courants versés par les ménages (y compris les entreprises individuelles)"|
                          
                              TITLE_FR1 ==  "Cotisations sociales employeurs versées par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Cotisations imputées versées par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Cotisations sociales effectives à la charge des ménages versées par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Primes nettes d'assurance-dommage versées par les ménages (y compris les entreprises individuelles)"|
                              TITLE_FR1 ==  "Transferts courants divers versés par les ménages (y compris les entreprises individuelles)"|
                                TITLE_FR1 == "Revenu disponible brut des ménages (y compris les entreprises individuelles)"
                              ) |>
  mutate(TITLE_FR1 =case_when (
    TITLE_FR1 == "Excédent brut d'exploitation des ménages hors EI (y compris revenus mixtes)" ~"ebe_hors_ei",
    TITLE_FR1 == "Excédent brut d'exploitation des entrepreneurs individuels (y compris revenus mixtes)" ~"ebe_ei",
      TITLE_FR1 =="Masse salariale reçue par les ménages (y compris les entreprises individuelles)" ~"sal_r",
      TITLE_FR1 =="Cotisations sociales employeurs reçues par les ménages (y compris les entreprises individuelles)" ~"cot_soc_r", 
    TITLE_FR1 == "Cotisations imputées reçues par les ménages (y compris les entreprises individuelles)"~"cot_imputees_r",
    TITLE_FR1 == "Intérêts reçus par les ménages (y compris les entreprises individuelles)"~"interet_r",
      TITLE_FR1 == "Dividendes reçus par les ménages (y compris les entreprises individuelles)"~"dividende_r",
      TITLE_FR1 == "Revenus de la propriété attribués aux assurés reçus par les ménages (y compris les entreprises individuelles)"~"rev_prop_assures_r",
      TITLE_FR1 == "Loyers des terrains et gisements reçus par les ménages (y compris les entreprises individuelles)"~"loyers_r",
      TITLE_FR1 == "Intérêts versés par les ménages (y compris les entreprises individuelles)"~"interet_v",
      TITLE_FR1 == "Loyers des terrains et gisements versés par les ménages (y compris les entreprises individuelles)"~"loyers_v",
      TITLE_FR1 ==  "Prestations de sécurité sociale en espèces reçues par les ménages (y compris les entreprises individuelles)"~"presta_ss_espece_r",
      TITLE_FR1 ==  "Autres prestations d'assurance sociale reçues par les ménages (y compris les entreprises individuelles)"~"autres_presta_ss_r",
      TITLE_FR1 ==  "Prestations d'assistance sociale en espèces reçues par les ménages (y compris les entreprises individuelles)"~"presta_ass_espece_r",
      TITLE_FR1 ==  "Indemnités d'assurance-dommage reçues par les ménages (y compris les entreprises individuelles)"~"chom_r",
      TITLE_FR1 ==  "Transferts courants divers reçus par les ménages (y compris les entreprises individuelles)"~"transfert_divers_r",
      TITLE_FR1 ==  "Impôts sur le revenu versés par les ménages (y compris les entreprises individuelles)"~"ir_v",
      TITLE_FR1 ==  "Autres impôts courants versés par les ménages (y compris les entreprises individuelles)"~"autres_impots_v",
    
      TITLE_FR1 ==  "Cotisations sociales employeurs versées par les ménages (y compris les entreprises individuelles)"~"cot_soc_v",
      TITLE_FR1 ==  "Cotisations imputées versées par les ménages (y compris les entreprises individuelles)"~"cot_imputees_v",
      TITLE_FR1 ==  "Cotisations sociales effectives à la charge des ménages versées par les ménages (y compris les entreprises individuelles)"~"cot_soc_eff_v",
      TITLE_FR1 ==  "Primes nettes d'assurance-dommage versées par les ménages (y compris les entreprises individuelles)"~"chom_v",
      TITLE_FR1 ==  "Transferts courants divers versés par les ménages (y compris les entreprises individuelles)"~"transfert_divers_v",
      TITLE_FR1 == "Revenu disponible brut des ménages (y compris les entreprises individuelles)"~"rdb_vrai"
  )) |>
  select(DATE, OBS_VALUE, TITLE_FR1) |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE)  |>
  mutate(rdb_test = ebe_hors_ei + ebe_ei + 
           sal_r+cot_soc_r+cot_imputees_r+interet_r+dividende_r+rev_prop_assures_r+ loyers_r - 
           interet_v - loyers_v +
           presta_ss_espece_r + autres_presta_ss_r+presta_ass_espece_r+ chom_r+transfert_divers_r - 
           ir_v - autres_impots_v - cot_soc_v - cot_imputees_v - cot_soc_eff_v - chom_v - transfert_divers_v) |>
  
  mutate(contrib_ebe = ebe_hors_ei) |>
  mutate(contrib_sal = sal_r+ebe_ei) |>
  mutate(contrib_presta = presta_ss_espece_r + autres_presta_ss_r+presta_ass_espece_r+ chom_r+transfert_divers_r- transfert_divers_v - chom_v) |>
  mutate(contrib_impot = ir_v + autres_impots_v + cot_soc_v + cot_imputees_v + cot_soc_eff_v - cot_soc_r-cot_imputees_r) |>
  mutate(contrib_propriete = loyers_r+rev_prop_assures_r+dividende_r+interet_r-interet_v - loyers_v) 

decompo_rdb_menages <- left_join(decompo_rdb_menages, pib_deflateur_conso_menages, by = "DATE") |>
  select(-pib_tot_vol)

decompo_rdb_menages <- decompo_rdb_menages |>
  arrange(DATE) |>
  mutate(var_sal = ((contrib_sal/lag(contrib_sal,1))-1)*100) |>
  mutate(var_ebe = ((contrib_ebe/lag(contrib_ebe,1))-1)*100)  |>
  mutate(var_impot = ((contrib_impot/lag(contrib_impot,1))-1)*100) |>
  mutate(var_prop = ((contrib_propriete/lag(contrib_propriete,1))-1)*100) |>
  mutate(var_presta = ((contrib_presta/lag(contrib_presta,1))-1)*100) |>
  mutate(var_pc = ((deflateur_conso_men/lag(deflateur_conso_men,1))-1)*100) |>
  mutate(part_sal = contrib_sal/rdb_test) |>
  mutate(part_impot = -contrib_impot/rdb_test) |>
  mutate(part_presta = contrib_presta/rdb_test) |>
  mutate(part_prop = contrib_propriete/rdb_test) |>
  mutate(part_ebe = contrib_ebe/rdb_test) |>
  mutate(sum = part_sal + part_impot + part_presta + part_ebe + part_prop) |>
  mutate(contrib_def_sal = part_sal*var_sal) |>
  mutate(contrib_def_impot = part_impot*var_impot) |>
  mutate(contrib_def_pc = -var_pc) |>
  mutate(contrib_def_ebe = part_ebe*var_ebe) |>
  mutate(contrib_def_presta = part_presta*var_presta) |>
  mutate(contrib_def_prop = part_prop*var_prop)

decompo_rdb_menages_def <- select(decompo_rdb_menages, DATE, contrib_def_sal, contrib_def_impot, contrib_def_pc, contrib_def_ebe, contrib_def_presta, contrib_def_prop) |>
  pivot_longer(cols=c(-1), names_to = "Composante", values_to = "value") |>
  filter(DATE >=as.Date('2019-10-01'))


var_pa_menages <- rdb_menages_2019 |>
  arrange(DATE) |>
  mutate(var_pa = ((pa_menages/lag(pa_menages,1))-1)*100) |>
  mutate(var_pa_uc = ((cum_pa_uc/lag(cum_pa_uc,1))-1)*100) |>
  select(DATE, var_pa, var_pa_uc) 

decompo_rdb_menages_def <- left_join(decompo_rdb_menages_def, var_pa_menages, by = "DATE")
decompo_rdb_menages_def <- decompo_rdb_menages_def |>
  mutate(Composante = case_when(
    Composante == "contrib_def_ebe"~"EBE des ménages purs", 
    Composante =="contrib_def_sal"~"Revenus d'activité", 
    Composante =="contrib_def_impot"~"Impôts et cotisations", 
    Composante =="contrib_def_presta"~"Prestations sociales", 
    Composante =="contrib_def_prop"~"Revenus de la propriété", 
    Composante =="contrib_def_pc"~"Prix à la consommation des ménages", 
  ))
decompo_rdb_menages_def <- mutate(decompo_rdb_menages_def, DATE2 = DATE+45)

valeur0 <- decompo_rdb_menages_def |>
  filter(DATE == max(DATE)) |>
  pull(var_pa) |>
  round(digits = 1)

valeur <- decompo_rdb_menages_def |>
  filter(DATE == max(DATE), Composante == "Revenus d'activité") |>
  pull(value) |>
  round(digits = 1)

valeur2 <- decompo_rdb_menages_def |>
  filter(DATE == max(DATE), Composante == "Prix à la consommation des ménages") |>
  pull(value) |>
  round(digits = 1)
plot_decompo_pa_menages <-  ggplot(data=decompo_rdb_menages_def, aes(x=DATE2, y=value, fill=forcats::fct_relevel(Composante, c("Revenus d'activité", 'EBE des ménages purs',
                                                                                                                              'Revenus de la propriété', "Prestations sociales", "Impôts et cotisations", "Prix à la consommation des ménages")))) +
  geom_col(position = "dodge2")+
  geom_line(aes(y = var_pa, color =  "Var. trimestrielle du pouvoir d'achat"), linewidth = 1.3) +
  labs(title = "Contributions à l'évolution du pouvoir d'achat et variation trimestrielle du pouvoir d'achat des ménages", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le pouvoir d'achat du RDB des ménages ", ifelse(valeur0>0, "augmente", "recule"), " de ", valeur0, " point en variation trimestrielle. \nLecture:Les revenus d'activité contribuent ", ifelse(valeur>0, "positivement", "négativement"), " au pouvoir d'achat des ménages à hauteur de ", valeur, " points. \nLecture: Les prix à la consommation y contribuent ",ifelse(valeur2>0, "positivement", "négativement")," à hauteur de ", valeur2, " points. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
    
       y = "Contribution (en point de pourcentage)", x = "Trimestre") +
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 16,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 16, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))+
  scale_colour_manual(values = c("Var. trimestrielle du pouvoir d'achat" = "blue")) + 
  scale_x_date(limits = as.Date(c("2019-10-01", NA))) +
  scale_fill_discrete(name = "Contribution", breaks=c("Revenus d'activité", 'EBE des ménages purs', 'Revenus de la propriété', "Prestations sociales", "Impôts et cotisations", "Prix à la consommation des ménages"))+
  #scale_color_manual(values=c("#F8766D","#C77CFF", "#00BA38", "#D39200", "#00B8E7"))+
  ylim(-10,10) 

print(plot_decompo_pa_menages)
rm(valeur0, valeur, valeur2)
```


## Taux d'épargne des ménages
```{r,fig.dim = c(14, 9)}
tx_ep_menage <- filter(csi_2014, TITLE_FR1 == "Épargne des ménages (y compris les entreprises individuelles)" |
                                 TITLE_FR1 == "Revenu disponible brut des ménages (y compris les entreprises individuelles)" | 
                                 TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ménages (y compris les entreprises individuelles)") |>
     mutate(TITLE_FR1 = case_when(
        TITLE_FR1 == "Épargne des ménages (y compris les entreprises individuelles)"~"epargne_men",
         TITLE_FR1 == "Revenu disponible brut des ménages (y compris les entreprises individuelles)"~ "rdb_men",
         TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ménages (y compris les entreprises individuelles)"~"capbesfi_men" 
       )) |>
     pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE) |>
     mutate(tx_epargne = epargne_men/rdb_men*100) |>
      mutate(tx_epargne_financiere = capbesfi_men/rdb_men*100) |>
     mutate(DATE = as.Date(DATE))

plot_tx_epargne_men <-ggplot(data = tx_ep_menage,
                              aes(x = DATE)) +
    geom_line(aes(y = tx_epargne, color = "Taux d'épargne des ménages"), size = 1.3) + 
    geom_line(aes(y = tx_epargne_financiere, color = "Taux d'épargne financière des ménages"), size = 1.1) + 
    labs(title = "Taux d'épargne des ménages", 
         
         subtitle = paste0("Lecture: Au ", date_def_litt, ", le taux d'épargne des ménages est de ", valeur <- tx_ep_menage |>filter(DATE == max(DATE)) |> pull(tx_epargne) |> round(digits =1)   , " %. Le taux d'épargne financière des ménages est de ",  valeur2 <- tx_ep_menage |>filter(DATE == max(DATE)) |> pull(tx_epargne_financiere) |> round(digits =1), " %. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
                  y = "Pourcentage (%)", x = "Année") +
    scale_x_date(limits = as.Date(c("2000-01-01", NA))) + 
    scale_color_manual(values = c("Taux d'épargne des ménages"="#00B8E7","Taux d'épargne financière des ménages" = "#F8766D"))+
     theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 18,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))

print(plot_tx_epargne_men)
rm(valeur, valeur2)
```

\newpage

# Compte des sociétés non financières (SNF)
## Taux de marge et taux d'investissement des SNF sur longue période
```{r,fig.dim = c(14, 9)}
compte_snf <- filter(csi_2014, TITLE_FR1 == "Excédent brut d'exploitation des sociétés non financières" |
                            TITLE_FR1 == "Valeur ajoutée des sociétés non financières" | 
                            TITLE_FR1 == "Épargne des sociétés non financières" |
                             TITLE_FR1 == "Formation brute de capital fixe des sociétés non financières") |>
  
  mutate(TITLE_FR1 = case_when(
                 TITLE_FR1 == "Excédent brut d'exploitation des sociétés non financières" ~"ebe_snf",
                 TITLE_FR1 == "Valeur ajoutée des sociétés non financières" ~"va_snf", 
                 TITLE_FR1 == "Épargne des sociétés non financières" ~"eb_snf",
                 TITLE_FR1 == "Formation brute de capital fixe des sociétés non financières"~"fbcf_snf"
                 )) |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE) |>
  mutate(tx_marge_snf = ebe_snf/va_snf*100) |>
  mutate(tx_fbcf_snf = fbcf_snf/va_snf*100) |>
  mutate(tx_autofinancement_snf = eb_snf/fbcf_snf*100) 
  
plot_compte_snf <-ggplot(data = compte_snf,
                              aes(x = DATE)) +
  geom_line(aes(y = tx_marge_snf, color = "Taux de marge"), size = 1.3) + 
  geom_line(aes(y = tx_fbcf_snf, color = "Taux d'investissement"), size = 1.3) + 
  #geom_line(aes(y = tx_autofinancement_snf, color = "Taux d'autofinancement"), size = 1.3) + 
  labs(title = "Taux de marge et d’investissement des sociétés non financières", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le taux de marge des Sociétés Non Financières (SNF) est de ", valeur <- compte_snf |>filter(DATE == max(DATE)) |> pull(tx_marge_snf) |> round(digits =1)   , " %. Le taux d'invesitssement des SNF est de ",  valeur2 <- compte_snf |>filter(DATE == max(DATE)) |> pull(tx_fbcf_snf) |> round(digits =1), " %. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "% de la valeur ajoutée des SNF", x = "Année") +
  scale_x_date(limits = as.Date(c("1970-10-01", NA))) + 
  scale_color_manual(values = c("Taux de marge"="#F8766D","Taux d'investissement" = "#00B8E7"))+
 theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))
print(plot_compte_snf)
rm(valeur, valeur2)
```


## Décomposition du taux des marges des SNF depuis 2018
```{r,fig.dim = c(14, 9)}
decompo_tm_snf_2018t4 <- filter(decompo_tm_snf, DATE >as.Date('2018-10-10')) |>
  mutate(sum_var_tx_marge = sum(var_tx_marge)) |>
  mutate(sum_prod = sum(contrib_productivite)) |>
  mutate(sum_sal = sum(contrib_sal_reel)) |>
  mutate(sum_cotsoc = sum(contrib_cot_soc)) |>
  mutate(sum_echange = sum(contrib_terme_echange)) |>
  mutate(sum_autres = sum(contrib_autres_facteurs)) |>
  filter(DATE == max(DATE)) |>
  select(DATE, sum_var_tx_marge, sum_prod, sum_sal, sum_cotsoc, sum_echange, sum_autres) |> 
  rename(c("Taux de marge"="sum_var_tx_marge", "Productivité" = sum_prod, "Masse salariale réelle" = sum_sal, 
           "Cotisations sociales" = "sum_cotsoc", "Termes de l'échange" = "sum_echange", "Autres facteurs" = sum_autres)) |>
  pivot_longer(cols=c(-1), names_to = "Composante", values_to = "value")

valeur <- decompo_tm_snf_2018t4 |>
  filter(DATE == max(DATE), Composante == "Taux de marge") |> pull(value) |> round(digits =1)
valeur2 <- decompo_tm_snf_2018t4 |>
  filter(DATE == max(DATE), Composante == "Masse salariale réelle") |> pull(value) |> round(digits =1)

plot_decompo_tm_snf_2018 <-ggplot(data = decompo_tm_snf_2018t4,
                                  aes(x = forcats::fct_relevel(Composante, c("Taux de marge", "Productivité","Masse salariale réelle","Cotisations sociales",
                                                                             "Termes de l'échange","Autres facteurs"), after = 1),
                                      y = value, fill = forcats::fct_relevel(Composante, c("Taux de marge", "Productivité","Masse salariale réelle","Cotisations sociales",
                                                                                           "Termes de l'échange","Autres facteurs"), after = 1))) +
  #fill=factor(ifelse(Composante=="Taux de marge","Highlighted","Normal")
  
  geom_col(position = "dodge", show.legend = FALSE) +
  labs(title = "Décomposition de la variation du taux de marge des sociétés non financières depuis la fin 2018", 
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", le taux de marge des SNF ", ifelse(valeur>0, "augmente", "recule"), " de ", valeur, " point depuis le T4-2018. \nLecture: L'évolution de la masse salariale réelle contribue ", ifelse(valeur2 >0, "positivement", "négativement"), " à hauteur de ", valeur2, " points à la variation du taux de marge. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
       y = "Variation en points de pourcentage par rapport au 4e trimestre 2018", x = "Facteur de contribution") +
  #scale_color_manual(name = "Composante", values=c("red","grey50","grey50","grey50","grey50","grey50")) 
  scale_fill_manual(values=c("orange", "#00B8E7", "#00B8E7", "#00B8E7", "#00B8E7", "#00B8E7")) + 
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))
print(plot_decompo_tm_snf_2018)
rm(valeur, valeur2)
```


```{r, echo=FALSE, message=FALSE, results='hide'}
recette_apu <- filter(csi_2014, TITLE_FR1 == "TVA reçue par les administrations publiques" | 
                        TITLE_FR1 =="Droits de douane reçus par les administrations publiques"|
                        TITLE_FR1 =="Impôts sur les produits reçus par les administrations publiques"|
                        TITLE_FR1 =="Impôts sur la main d'oeuvre reçus par les administrations publiques"|
                        TITLE_FR1 =="Autres impôts sur la production reçus par les administrations publiques"|
                        TITLE_FR1 =="Impôts sur le revenu reçus par les administrations publiques"|
                        TITLE_FR1 =="Autres impôts courants reçus par les administrations publiques"|
                       	
                        TITLE_FR1 =="Impôts en capital reçus par les administrations publiques" |
                        TITLE_FR1 =="Cotisations imputées reçues par les administrations publiques"|
                        TITLE_FR1 =="Cotisations sociales employeurs reçues par les administrations publiques"|
                        TITLE_FR1 =="Cotisations sociales effectives à la charge des ménages reçues par les administrations publiques" | 
                        TITLE_FR1 =="Total des recettes des APU" |
                        TITLE_FR1 =="Total des dépenses des APU" | 
                        TITLE_FR1 =="Subventions versées par les APU" |
                        
                        TITLE_FR1 == "Consommations intermédiaires des administrations publiques"|
                        TITLE_FR1 == "Rémunérations salariales versées par les administrations publiques"|
                        TITLE_FR1 =="Impôts sur la production des administrations publiques"|
                        TITLE_FR1 =="Loyers des terrains et gisements versés par les administrations publiques"|
                        TITLE_FR1 == "Impôts sur le revenu versés par les administrations publiques"|
                        TITLE_FR1 =="Impôts sur la main d'oeuvre versés par les administrations publiques"|
                        TITLE_FR1 =="Autres impôts sur la production versés par les administrations publiques"|
                        TITLE_FR1 == "Intérêts versés par les administrations publiques" |
                      TITLE_FR1 =="Prestations de sécurité sociale en espèces versées par les administrations publiques" |
                      TITLE_FR1 =="Prestations d'assistance sociale en espèces versées par les administrations publiques" |
                      TITLE_FR1 =="Autres prestations d'assurance sociale versées par les administrations publiques" |
                      TITLE_FR1 =="Transferts sociaux en nature de produits marchands versés par les administrations publiques" |
                      TITLE_FR1 =="Transferts sociaux en nature de produits non marchands versés par les administrations publiques" |
                      TITLE_FR1 =="Transferts courants entre APU versés par les administrations publiques" |
                      TITLE_FR1 =="Primes nettes d'assurance-dommage versées par les administrations publiques" |
                      TITLE_FR1 =="Coopération internationale versée par les administrations publiques" |
                      TITLE_FR1 =="Transferts courants divers versés par les administrations publiques" |
                      TITLE_FR1 =="Ressources propres de l'UE versées par les administrations publiques" |
                      TITLE_FR1 =="Autres transferts en capital à payer par les administrations publiques" |
                      TITLE_FR1 =="Aides à l'investissement à payer par les administrations publiques" |
                      TITLE_FR1 =="Formation brute de capital fixe des administrations publiques" |
                      TITLE_FR1 =="Acquisitions nettes d'actifs non produits des administrations publiques"
                      ) |>

          mutate(TITLE_FR1 = case_when(
            TITLE_FR1 == "TVA reçue par les administrations publiques"~"tva",  
                   TITLE_FR1 =="Droits de douane reçus par les administrations publiques"~"douane", 
                   TITLE_FR1 =="Impôts sur les produits reçus par les administrations publiques"~"impot_produit", 
                   TITLE_FR1 =="Impôts sur la main d'oeuvre reçus par les administrations publiques"~"impot_main_oeuvre", 
                   TITLE_FR1 =="Autres impôts sur la production reçus par les administrations publiques"~"autre_impot_prod", 
                   TITLE_FR1 =="Impôts sur le revenu reçus par les administrations publiques"~"ir", 
                   TITLE_FR1 =="Autres impôts courants reçus par les administrations publiques"~"autre_impot_courant", 
            TITLE_FR1 =="Impôts en capital reçus par les administrations publiques" ~"impot_capital",
                   TITLE_FR1 =="Cotisations imputées reçues par les administrations publiques"~"cot_imputees", 
                   TITLE_FR1 =="Cotisations sociales employeurs reçues par les administrations publiques"~"cot_soc_employeurs", 
                   TITLE_FR1 =="Cotisations sociales effectives à la charge des ménages reçues par les administrations publiques"~"cot_soc_menages", 
                   TITLE_FR1 =="Total des recettes des APU"~"tot_recettes_apu",
                   TITLE_FR1 =="Total des dépenses des APU"~"tot_depenses_apu", 
                  TITLE_FR1 =="Subventions versées par les APU"~"tot_subventions_apu", 
          
            
            TITLE_FR1 == "Consommations intermédiaires des administrations publiques"~"ci_apu", 
            TITLE_FR1 == "Rémunérations salariales versées par les administrations publiques"~"masse_salariale_apu", 
            TITLE_FR1 =="Impôts sur la production des administrations publiques"~"impot_prod_apu", 
            TITLE_FR1 =="Loyers des terrains et gisements versés par les administrations publiques"~"loyers_verses_apu", 
            TITLE_FR1 == "Impôts sur le revenu versés par les administrations publiques"~"impots_rev_pat_verses_apu", 
            TITLE_FR1 =="Impôts sur la main d'oeuvre versés par les administrations publiques"~"impots_main_oeuvre_verses_apu", 
             TITLE_FR1 =="Autres impôts sur la production versés par les administrations publiques"~"autres_impots_production_verses_apu", 
            
            TITLE_FR1 == "Intérêts versés par les administrations publiques"~"interets_verses_apu",
            
            TITLE_FR1 =="Prestations de sécurité sociale en espèces versées par les administrations publiques" ~"presta_ss_especes_versees_apu",
            TITLE_FR1 =="Prestations d'assistance sociale en espèces versées par les administrations publiques" ~"presta_ass_especes_versees_apu",
            TITLE_FR1 =="Autres prestations d'assurance sociale versées par les administrations publiques" ~"autres_presta_ass_versees_apu",
            TITLE_FR1 =="Transferts sociaux en nature de produits marchands versés par les administrations publiques" ~"transfert_nature_marchand_verse_apu",
            TITLE_FR1 =="Transferts sociaux en nature de produits non marchands versés par les administrations publiques" ~"transfert_nature_non_marchand_verse_apu",
            TITLE_FR1 =="Primes nettes d'assurance-dommage versées par les administrations publiques"~"ass_chom_verse_apu",
            
            TITLE_FR1 =="Transferts courants entre APU versés par les administrations publiques"~"transfert_entre_apu_verse_apu",
            TITLE_FR1 =="Coopération internationale versée par les administrations publiques"~"coop_int_versee_apu",
            TITLE_FR1 =="Transferts courants divers versés par les administrations publiques"~"transfert_courants_divers_apu",
            TITLE_FR1 =="Ressources propres de l'UE versées par les administrations publiques"~"ressources_ue_verse_apu",
            
            TITLE_FR1 =="Autres transferts en capital à payer par les administrations publiques"~"transfert_capital_verse_apu",
            TITLE_FR1 =="Aides à l'investissement à payer par les administrations publiques"~"aide_investissmt_verse_apu",
            TITLE_FR1 =="Formation brute de capital fixe des administrations publiques"~"fbcf_apu",
            TITLE_FR1 =="Acquisitions nettes d'actifs non produits des administrations publiques"~"acquisition_nette_actif_non_produit_par_apu",
            )) |>
            pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE) |>
  mutate(taxe_conso = tva+douane) |>
  mutate(taxe_production = impot_produit + impot_main_oeuvre + autre_impot_prod) |>
  mutate(impot_rev_pat = ir + autre_impot_courant+impot_capital) |>
  mutate(cot_soc = cot_imputees + cot_soc_employeurs + cot_soc_menages) |>
  mutate(tot_po = taxe_conso+taxe_production+impot_rev_pat+cot_soc) |>
  
  ####
  mutate(tot_depenses_fonctionnement = masse_salariale_apu + impot_prod_apu + ci_apu + loyers_verses_apu + impots_rev_pat_verses_apu + impots_main_oeuvre_verses_apu + autres_impots_production_verses_apu) |>
  mutate(tot_depenses_transferts_sociaux = presta_ss_especes_versees_apu + presta_ass_especes_versees_apu + autres_presta_ass_versees_apu + ass_chom_verse_apu + transfert_nature_marchand_verse_apu) |>
  mutate(tot_autres_transferts = transfert_entre_apu_verse_apu + coop_int_versee_apu + transfert_courants_divers_apu + ressources_ue_verse_apu) |>
  mutate(total_investissement = transfert_capital_verse_apu + aide_investissmt_verse_apu + acquisition_nette_actif_non_produit_par_apu + fbcf_apu) |>
  arrange(DATE) |>
  mutate(def_taxe_conso = ((taxe_conso/lag(taxe_conso, 4))-1)*100) |>
  mutate(def_taxe_production = ((taxe_production/lag(taxe_production, 1))-1)*100) |>
  mutate(def_taxe_rev_pat = ((impot_rev_pat/lag(impot_rev_pat, 4))-1)*100) |>
  mutate(def_cot_soc = ((cot_soc/lag(cot_soc, 4))-1)*100) |>
  mutate(def_recette  = ((tot_recettes_apu/lag(tot_recettes_apu,4))-1)*100) |>
  mutate(def_po = ((tot_po/lag(tot_po, 4))-1)*100)

recette_apu <- left_join(recette_apu , pib_deflateur_conso_menages, by = "DATE") |> 
  select(-deflateur_conso_men, -pib_tot_vol) |>
  arrange(DATE) |>
  mutate(def_pib = ((pib_tot_val/lag(pib_tot_val, 4))-1)*100) |>
  mutate(elasticite_taxe_conso = def_taxe_conso/def_pib) |>
  mutate(elasticite_taxe_production = def_taxe_production/def_pib) |>
  mutate(elasticite_taxe_rev_pat = def_taxe_rev_pat/def_pib) |>
  mutate(elasticite_cot_soc = def_cot_soc/def_pib) |>
  mutate(elasticite_recettes_tot = def_recette/def_pib) |>
  mutate(elasticite_po = def_po/def_pib) |>
  mutate(tot_recettes_apu_pib = tot_recettes_apu/pib_tot_val*100) |>
  mutate(tot_depenses_apu_pib = tot_depenses_apu/pib_tot_val*100) |>
  mutate(depenses_subventions_apu_pib = tot_subventions_apu/pib_tot_val*100) |>
  mutate(tot_depenses_hors_subvention_apu_pib = tot_depenses_apu_pib - depenses_subventions_apu_pib) |>

  mutate(depenses_fonctionnement_pib = tot_depenses_fonctionnement/pib_tot_val*100) |>
  mutate(depenses_interet_pib = interets_verses_apu/pib_tot_val*100) |>
  mutate(depenses_transferts_sociaux_pib = tot_depenses_transferts_sociaux/pib_tot_val*100) |>
  mutate(depenses_autres_transferts_pib = tot_autres_transferts/pib_tot_val*100) |>
  mutate(depenses_investissement_pib = total_investissement/pib_tot_val*100) |>
  mutate(tot_decompo_globale = depenses_fonctionnement_pib + depenses_interet_pib + 
                              depenses_transferts_sociaux_pib +depenses_autres_transferts_pib + 
                              depenses_investissement_pib+ depenses_subventions_apu_pib)

```

\newpage 

# Comptes des administrations publiques (APU)
## Part des recettes et des dépenses des APU 
```{r,fig.dim = c(14, 9)}
#Plot dépenses recettes en % du PIB valeur 
plot_deficit_apu_pib <- ggplot(data = recette_apu,
                               aes(x = DATE)) +
  geom_line(aes(y = tot_recettes_apu_pib, color = "Total des recettes"), size = 1.3) + 
  geom_line(aes(y = tot_depenses_apu_pib, color = "Total des dépenses"), size = 1.3) + 
  #geom_line(aes(y = tot_depenses_hors_subvention_apu_pib, color = "Total des dépenses hors subventions"), size = 1.1) + 
  
  labs(title = "Recettes et dépenses des administrations publiques rapportées au PIB",
       
       subtitle = paste0("Lecture: Au ", date_def_litt, ", les recettes des APU représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(tot_recettes_apu_pib) |> round(digits =1), " % du PIB et les dépenses des APU représentent ", valeur2 <- recette_apu |> filter(DATE == max(DATE)) |> pull(tot_depenses_apu_pib) |> round(digits =1), " % du PIB.\nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Total des dépenses"="#F8766D",
                                #"Total des dépenses hors subventions"="purple", 
                                "Total des recettes" = "#00B8E7"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 16,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 16, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +
  ylim(45, NA)
print(plot_deficit_apu_pib)
rm(valeur, valeur2)
```


## Prélèvements obligatoires en part du PIB
```{r, fig.dim=c(16,10)}
structure_po2 <- select(recette_apu, DATE, pib_tot_val,tot_recettes_apu, taxe_conso, taxe_production, impot_rev_pat, cot_soc, tot_subventions_apu) |>
  mutate(impot_prod_net = taxe_production-tot_subventions_apu) |>
  mutate(taxe_conso=taxe_conso/pib_tot_val*100) |>
  mutate(impot_prod_net =impot_prod_net/pib_tot_val*100) |>
  mutate(cot_soc=cot_soc/pib_tot_val*100) |>
  mutate(impot_rev_pat=impot_rev_pat/pib_tot_val*100) |>
  mutate(tx_po = taxe_conso+impot_prod_net+cot_soc+impot_rev_pat) |>
  select(-tot_subventions_apu, - taxe_production, -pib_tot_val, -tot_recettes_apu) |>
  pivot_longer(cols=c(-1,), names_to = "title", values_to = "OBS_VALUE") |>
  mutate(title = case_when(
    title == "tx_po"~"Ensemble des prélèvements obligatoires",
    title == "taxe_conso"~"Taxes à la consommation (TVA et droits de douane)",
    title == "impot_prod_net"~"Impôts nets de subvention sur la production", 
    title == "impot_rev_pat"~"Impôts sur le revenu et le patrimoine", 
    title == "cot_soc"~"Cotisations sociales (employés et employeurs)"
  )) |>
  filter(DATE >= as.Date('1980-01-01')) |>
  mutate(title2 = ifelse(title == "Ensemble des prélèvements obligatoires","Ensemble des PO", "Part de chaque PO"))

valeur <- structure_po2 %>%
  filter(DATE == max(DATE), title == "Impôts nets de subvention sur la production") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

valeur2 <- structure_po2 %>%
  filter(DATE == max(DATE), title == "Ensemble des prélèvements obligatoires") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

plot_structure_po2 <-  ggplot(data=structure_po2, aes(x=DATE, y= OBS_VALUE, fill = forcats::fct_relevel(title, c("Ensemble des prélèvements obligatoires", "Impôts sur la production",
                                                                                                          "Cotisations sociales (employés et employeurs)", 
                                                                                                          "Taxes à la consommation (TVA et droits de douane)",
                                                                                                          "Impôts sur le revenu et le patrimoine"
                                   )))) +
  geom_line(aes(y = OBS_VALUE, color = title), size =1.1)+
  labs(title = "Structure des prélèvements obligatoires", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", le taux de prélèvements obligatoires représente ", valeur2, " % du PIB. Les impôts sur la production nets de subventions représentent ",valeur, " % du PIB.  \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "% du PIB valeur", x = "Date", fill='title') +
  #scale_color_manual(values = c("#333333"))
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 12,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        legend.title = element_text(size=9), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) +
  guides(
    color = guide_legend(
      ncol = 3,                # Diviser en 3 colonnes
      title.position = "top",  # Positionner le titre de la légende en haut
      title.hjust = 0.5        # Centrer le titre de la légende
    )) + 
  facet_wrap(vars(title2), scales = "free",ncol = 2)

print(plot_structure_po2)
``` 


## Structure des prélèvements obligatoires 
```{r, fig.dim=c(14,8)}
structure_po <- select(recette_apu, DATE, tot_recettes_apu, taxe_conso, taxe_production, impot_rev_pat, cot_soc, tot_subventions_apu) |>
  mutate(impot_prod_net = taxe_production-tot_subventions_apu) |>
  select(-taxe_production, -tot_subventions_apu) |>
  pivot_longer(cols=c(-1,-2), names_to = "title", values_to = "OBS_VALUE") |>
  mutate(title = case_when(
    title == "taxe_conso"~"Taxes à la consommation (TVA et droits de douane)",
    title == "impot_prod_net"~"Impôts nets de subventions sur la production", 
    title == "impot_rev_pat"~"Impôts sur le revenu et le patrimoine", 
    title == "cot_soc"~"Cotisations sociales (employés et employeurs)"
  )) |>
  group_by(DATE) |>
  mutate(sum = sum(OBS_VALUE)) |>
  ungroup() |>
  mutate(percent = OBS_VALUE/sum*100) |>
  filter(DATE >= as.Date('1980-01-01'))

valeur <- structure_po %>%
  filter(DATE == max(DATE), title == "Impôts nets de subventions sur la production") %>%
  pull(percent)  %>%
  round(digits = 1)

plot_structure_po <-  ggplot(data=structure_po, aes(x=DATE, y= percent, fill = forcats::fct_relevel(title, c("Impôts nets de subventions sur la production",
                                                                                                          "Cotisations sociales (employés et employeurs)", 
                                                                                                          "Taxes à la consommation (TVA et droits de douane)",
                                                                                                          "Impôts sur le revenu et le patrimoine"
                                   )))) +
  geom_line(aes(y = percent, color = title), size =1.1)+
  labs(title = "Structure des prélèvements obligatoires (tenant compte des subventions à la production)", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", les impôts nets de subventions sur la production représentent ",valeur, " % des prélèvements obligatoires reçus par les administrations publiques.  \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "Part des prélèvements obligatoires (%)", x = "Date", fill='title') +
  #scale_color_manual(values = c("#333333"))
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 12,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        legend.title = element_text(size=9), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +
  scale_x_date(limits = as.Date(c("1990-01-01", NA)))  + ylim(0,NA) +
  guides(
    color = guide_legend(
      ncol = 3,                # Diviser en 3 colonnes
      title.position = "top",  # Positionner le titre de la légende en haut
      title.hjust = 0.5        # Centrer le titre de la légende
    ))

print(plot_structure_po)
```

## Elasticité des recettes fiscales (en glissement annuel)
```{r, fig.dim=c(14,8)}
elasticite_po <- select(recette_apu, DATE, def_recette, def_pib) |>
  mutate(elasticite_po = def_recette/def_pib) |>
  pivot_longer(cols=c(-1), names_to = "title", values_to = "OBS_VALUE") |>
  mutate(title = case_when(
    title == "def_recette"~"Glissement annuel des recettes des APU",
    title == "def_pib"~"Glissement annuel du PIB valeur", 
     title == "elasticite_po"~"Elasticité des recettes", 
  )) 
elasticite_po1 <- filter(elasticite_po, title !="Elasticité des recettes")
elasticite_po2 <- filter(elasticite_po, title =="Elasticité des recettes")
valeur1 <- elasticite_po1 %>%
  filter(DATE == max(DATE), title == "Glissement annuel des recettes des APU") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

valeur11 <- elasticite_po1 %>%
  filter(DATE == max(DATE), title == "Glissement annuel du PIB valeur") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

plot_elasticite_po <-  ggplot(data=elasticite_po1, aes(x=DATE, y= OBS_VALUE, fill = forcats::fct_relevel(title, c("Glissement annuel des recettes des APU","Glissement annuel du PIB valeur"
                                   )))) +
  geom_line(aes(y = OBS_VALUE, color = title), size =1.1)+
  labs(title = "Glissement annuel des recettes des APU et du PIB valeur", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", sur un an, les recettes fiscales des APU ", ifelse(valeur1>0, "augmentent", "baissent"), " de ", valeur1, " % alors que le PIB en valeur augmente de ", valeur11, " %.\nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "Glissement annuel (%)", x = "Date", fill='title') +
  #scale_color_manual(values = c("#333333"))
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 12,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        legend.title = element_text(size=9), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +
  scale_x_date(limits = as.Date(c("1990-01-01", NA))) + 
  guides(fill=guide_legend(nrow=2,byrow=TRUE))

print(plot_elasticite_po)
```
```{r, fig.dim= c(14,8)}
valeur2 <- elasticite_po2 %>%
  filter(DATE == max(DATE), title == "Elasticité des recettes") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

plot_elasticite_po2 <-  ggplot(data=elasticite_po2, aes(x=DATE, y= OBS_VALUE, fill = forcats::fct_relevel(title, c("Elasticité des recettes"
                                   )))) +
  geom_line(aes(y = OBS_VALUE, color = title), size =1.1)+
  geom_hline(yintercept=1, linetype="dashed", color = "black")+
  labs(title = "Elasticité des recettes fiscales par rapport au PIB (en glissement annuel)", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", en glissement annuel, les recettes fiscales des APU augmentent ", valeur2, " ", ifelse(valeur2>1, "fois plus vite", "fois moins vite")," que le PIB valeur.\nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "Elasticitié", x = "Date", fill='title') +
  ylim(-1,NA)+
  #scale_color_manual(values = c("#333333"))
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 12,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        legend.title = element_text(size=9), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +
  scale_x_date(limits = as.Date(c("1990-01-01", NA)))  +
  guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

print(plot_elasticite_po2)
```

## Dyamisme des différentes recettes fiscales en glissement annuel 
```{r, fig.dim= c(14,9)}
dynamisme_recettes <- select(recette_apu, DATE, elasticite_recettes_tot,elasticite_po, elasticite_taxe_conso, elasticite_taxe_production,elasticite_cot_soc,elasticite_taxe_rev_pat) |>
pivot_longer(cols=c(-1), names_to = "title", values_to = "OBS_VALUE") |>
  mutate(title = case_when(
    title == "elasticite_recettes_tot"~"Recettes totales",
    title == "elasticite_po"~"Ensemble des PO", 
     title == "elasticite_taxe_conso"~"Taxes sur la consommation", 
    title == "elasticite_taxe_production"~"Taxes sur la production", 
    title == "elasticite_cot_soc"~"Cotisations sociales",
    title == "elasticite_taxe_rev_pat"~"Impôts sur le revenu et le patrimoine")) 
dynamisme_recettes <- filter(dynamisme_recettes, DATE == max(DATE) |DATE==max(dynamisme_recettes$DATE[dynamisme_recettes$DATE!=max(dynamisme_recettes$DATE)])) |>
  mutate(DATE = as.character(DATE))


valeur <- dynamisme_recettes %>%
  filter(DATE == max(DATE), title == "Recettes totales") %>%
  pull(OBS_VALUE)  %>%
  round(digits = 1)

plot_dynamisme_po <-  ggplot(data=dynamisme_recettes, aes(x=forcats::fct_relevel(title, c("Recettes totales",
    "Ensemble des PO",
    "Taxes sur la consommation",
   "Taxes sur la production",
    "Cotisations sociales",
   "Impôts sur le revenu et le patrimoine"
                                   )), y= OBS_VALUE, fill = DATE))+ 
  geom_col(position = "dodge2")+
  geom_hline(yintercept=1, linetype="dashed", color = "black") +
  labs(title = "Elasticité des différentes recettes des APU (en glissement annuel)", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", en glissement annuel, l'élasticité de l'ensemble des recettes des APU est de ", valeur, ".\nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
  
       y = "Elasticite", x = "Date", fill='title') +
  #scale_color_manual(values = c("#333333"))
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 18,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 12,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        legend.title = element_text(size=9), 
        axis.text.x = element_text(angle = 90),
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) 
print(plot_dynamisme_po)

```


## Décomposition de la dépense publique par fonctions
```{r,fig.dim = c(14, 16)}
######Décomposition des dépenses 
#Dépenses de fonctionnement 
plot_dep_fonctionnement_apu_pib <- ggplot(data = recette_apu,
                                   aes(x = DATE)) +
  geom_line(aes(y = depenses_fonctionnement_pib, color = "Dépenses de fonctionnement"), size = 1.3) + 
  labs(title = "Total des dépenses de fonctionnement", 
       subtitle = paste0("Lecture: Au ", date_def_litt, ", les dépenses de fonctionnement représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_fonctionnement_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"), 
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Dépenses de fonctionnement"="blue"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5)) +ylim(16, NA)
 

#Total des subventions 
plot_subventions_apu_pib <- ggplot(data = recette_apu,
                               aes(x = DATE)) +
  geom_line(aes(y = depenses_subventions_apu_pib, color = "Total des subventions"), size = 1.3) + 
  labs(title = "Subventions versées par les administrations publiques", 
              subtitle = paste0("Lecture: Au ", date_def_litt, ", les subventions représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_subventions_apu_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"),
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Total des subventions"="purple"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))

#Total des intérêts versés
plot_interet_verses_apu_pib <- ggplot(data = recette_apu,
                                   aes(x = DATE)) +
  geom_line(aes(y = depenses_interet_pib, color = "Total des intérêts versés"), size = 1.3) + 
  labs(title = "Charges d'intérêts versées par les administrations publiques", 
       subtitle = paste0("Lecture: Au ", date_def_litt, ", la charge d'intérêt représente ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_interet_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"),

       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Total des intérêts versés"="#993300"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))


plot_transferts_sociaux_nature_pib <- ggplot(data = recette_apu,
                                      aes(x = DATE)) +
  geom_line(aes(y = depenses_transferts_sociaux_pib, color = "Total des transferts sociaux ou marchands en nature"), size = 1.3) + 
  labs(title = "Transferts sociaux et apparentés (en espèce ou en nature)", 
       subtitle = paste0("Lecture: Au ", date_def_litt, ", les transferts sociaux représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_transferts_sociaux_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"),
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Total des transferts sociaux ou marchands en nature"="#FF33FF"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))+ ylim(15, NA) 


plot_autres_transferts_pib <- ggplot(data = recette_apu,
                                             aes(x = DATE)) +
  geom_line(aes(y = depenses_autres_transferts_pib, color = "Autres transferts entre administrations"), size = 1.3) + 
  labs(title = "Transferts entre administrations", 
        subtitle = paste0("Lecture: Au ", date_def_litt, ", les transferts entre administrations représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_autres_transferts_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"),
       
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Autres transferts entre administrations"="orange"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))


plot_investissement_apu_pib <- ggplot(data = recette_apu,
                                     aes(x = DATE)) +
  geom_line(aes(y = depenses_investissement_pib, color = "Dépenses reliées à l'investissement"), size = 1.3) + 
  labs(title = "Dépenses reliées à l'investissement", 
       
               subtitle = paste0("Lecture: Au ", date_def_litt, ", les dépenses d'investissement représentent ", valeur <- recette_apu |> filter(DATE == max(DATE)) |> pull(depenses_investissement_pib) |> round(digits =1), " % du PIB. \nSource : Insee (Comptes nationaux Trimestriels - Dernier point : 1er trimestre 2023) \nCalculs et graphiques : @statjunior"),
       
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1980-01-01", NA))) + 
  scale_color_manual(values = c("Dépenses reliées à l'investissement"="#339900"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))


plot_decompo_depenses <- plot_grid(plot_dep_fonctionnement_apu_pib, plot_subventions_apu_pib,  
                                   plot_transferts_sociaux_nature_pib, plot_autres_transferts_pib, 
                                   plot_investissement_apu_pib, plot_interet_verses_apu_pib, ncol = 2, nrow = 3)
print(plot_decompo_depenses)

```


## Taux de déficit public des APU (avec et hors charge d'intérêt)
```{r,fig.dim = c(14, 9)}
#######Déficit des APU
deficit_apu <- filter(csi_2014, TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des administrations publiques" | 
                        TITLE_FR1 == "Intérêts reçus par les administrations publiques" | 
                        TITLE_FR1 =="Intérêts versés par les administrations publiques") |>
  mutate(TITLE_FR1 = case_when(
    TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des administrations publiques"~"def_apu", 
    TITLE_FR1 == "Intérêts reçus par les administrations publiques"~"interet_recu_apu", 
    TITLE_FR1 == "Intérêts versés par les administrations publiques"~"interet_verses_apu"
  )) |>
  select(DATE, OBS_VALUE, TITLE_FR1) |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE) |>
  mutate(def_sans_interet = def_apu+interet_verses_apu-interet_recu_apu)

deficit_apu <- left_join(deficit_apu, pib_deflateur_conso_menages, by = "DATE") 
deficit_apu <- select(deficit_apu, -deflateur_conso_men, -pib_tot_vol) |>
  mutate(def_total_pib = def_apu/pib_tot_val*100) |>
  mutate(def_primaire_pib = def_sans_interet/pib_tot_val*100) |>
  mutate(trim1 = ifelse(substr(DATE, 6, 7)== "01", 1, 0 )) |>
  mutate(trim2 = ifelse(substr(DATE, 6, 7)== "04", 1, 0 )) |>
  mutate(trim3 = ifelse(substr(DATE, 6, 7)== "07", 1, 0 )) 

plot_deficit_apu_pib <- ggplot(data = deficit_apu,
                           aes(x = DATE)) +
  geom_line(aes(y = def_primaire_pib, color = "Déficit primaire (hors charge d'intérêt reçue et versée)"), size = 1.3) + 
  geom_line(aes(y = def_total_pib, color = "Déficit total"), size = 1.3) + 
  geom_hline(yintercept=-3, linetype="dashed", color = "black") +
  labs(title = "Déficit public des APU et déficit primaire hors charge d'intérêt rapporté au PIB", 
       
        subtitle = paste0("Lecture: Au ", date_def_litt, ", le déficit public est de ", valeur <-deficit_apu |>filter(DATE == max(DATE)) |> pull(def_total_pib) |> round(digits =1), " % du PIB. Le déficit primaire (hors charge d'intérêt) est de ", valeur2 <- deficit_apu |>filter(DATE == max(DATE)) |> pull(def_primaire_pib) |> round(digits =1), " % du PIB. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1970-10-01", NA))) + 
  scale_color_manual(values = c("Déficit total"="#F8766D","Déficit primaire (hors charge d'intérêt reçue et versée)" = "#00B8E7"))+
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 16,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 16, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))

print(plot_deficit_apu_pib)

```

## Charge d'intérêt nette (versée - reçue) des administrations publiques
```{r,fig.dim = c(14, 16)}
interet_apu <- filter(csi_2014, TITLE_FR1 == "Intérêts reçus par les administrations publiques" | 
                       TITLE_FR1 =="Intérêts versés par les administrations publiques") |>
  mutate(TITLE_FR1 = case_when(
    TITLE_FR1 == "Intérêts reçus par les administrations publiques"~"interet_recu_apu", 
    TITLE_FR1 == "Intérêts versés par les administrations publiques"~"interet_verses_apu"
  )) |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE)  |>
  mutate(interet_net = (interet_verses_apu - interet_recu_apu)/1000)

interet_apu <- left_join(interet_apu, pib_deflateur_conso_menages, by = "DATE") 
interet_apu <- select(interet_apu, -deflateur_conso_men, -pib_tot_vol) |>
  mutate(interet_pib = (interet_net*1000)/pib_tot_val*100)

plot_interet_val <- ggplot(data = interet_apu,
                                 aes(x = DATE)) +
  geom_line(aes(y = interet_net), color = "#00B8E7", size = 1.3) + 
  labs(title = "Charge d'intérêt nette nominale des administrations publiques", 
       
        subtitle = paste0("Lecture: Au ", date_def_litt, ", la charge d'intérêt nette des APU est de ",valeur <- interet_apu |> filter(DATE == max(DATE)) |> pull(interet_net) |> round(digits =1), " milliards d'euros. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
       y = "Milliards d'€", x = "Année") +
  scale_x_date(limits = as.Date(c("1970-10-01", NA))) + 
 theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))


plot_interet_pib <- ggplot(data = interet_apu,
                           aes(x = DATE)) +
  geom_line(aes(y = interet_pib), color = "#00B8E7", size = 1.3) + 
  labs(title = "Charge d'intérêt nette des administrations publiques en proportion du PIB nominal", 
       
      subtitle = paste0("Lecture: Au ", date_def_litt, ", la charge d'intérêt nette des APU représente ",valeur <- interet_apu |> filter(DATE == max(DATE)) |> pull(interet_pib) |> round(digits =1), " % du PIB nominal. \nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
      
       y = "% du PIB valeur", x = "Année") +
  scale_x_date(limits = as.Date(c("1970-10-01", NA))) + 
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 14,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 14, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))

plot_interet_apu <- plot_grid(plot_interet_val, plot_interet_pib, ncol = 1, nrow = 2)
print(plot_interet_apu)

```


\newpage 

# Capacité ou Besoin de financement vis-à-vis du Reste du monde
```{r,fig.dim = c(14, 9)}
capbesfi <- filter(csi_2014, TITLE_FR1 == "Capacité (+) ou besoin (-) de financement du reste du monde" |
                     TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des sociétés non financières" | 
                     TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ISBLSM" |
                     TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des administrations publiques" |
                     TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ménages (y compris les entreprises individuelles)" |
                     TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des sociétés financières") |>
  
  mutate(TITLE_FR1 = case_when( 
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement du reste du monde" ~"total",
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des sociétés non financières" ~"snf", 
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ISBLSM" ~"isblsm",
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des administrations publiques" ~"apu",
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des ménages (y compris les entreprises individuelles)" ~"men",
  TITLE_FR1 == "Capacité (+) ou besoin (-) de financement des sociétés financières"~"sf"
  )) |>
  select(DATE, OBS_VALUE, TITLE_FR1) |>
  pivot_wider(names_from = TITLE_FR1, values_from = OBS_VALUE, id_cols = DATE)

capbesfi <- left_join(capbesfi, pib_deflateur_conso_menages, by = "DATE") |>
  select(-pib_tot_vol, -deflateur_conso_men) |>
  mutate(capbesfi_apu_pib = apu/pib_tot_val*100) |>
  mutate(capbesfi_men_pib = men/pib_tot_val*100) |>
  mutate(capbesfi_sf_pib = sf/pib_tot_val*100) |>
  mutate(capbesfi_snf_pib = snf/pib_tot_val*100) |>
  mutate(capbesfi_isblsm_pib = isblsm/pib_tot_val*100) |>
  mutate(capbesfi_total_pib = total/pib_tot_val*100) |>
  select(DATE, capbesfi_apu_pib, capbesfi_men_pib, capbesfi_sf_pib, capbesfi_snf_pib, capbesfi_isblsm_pib,capbesfi_total_pib) |>
  pivot_longer(cols=c(2:6), names_to = "Composante", values_to = "value") |>
  mutate(Composante = case_when(
    Composante == "capbesfi_isblsm_pib"~"ISBLSM",
    Composante == "capbesfi_men_pib"~"Ménages",
    Composante == "capbesfi_sf_pib"~"Sociétés financières",
    Composante == "capbesfi_snf_pib"~"Sociétés non financières",
    Composante == "capbesfi_apu_pib"~"APU",
  ))  |>
  mutate(value = round(value, 2)) |>
  mutate(capbesfi_total_pib = -capbesfi_total_pib) |>
  mutate(capbesfi_total_pib = round(capbesfi_total_pib, 2))

valeur <- capbesfi |> filter(DATE == max(DATE)) |> pull(capbesfi_total_pib) |>
  round(digits = 1)
valeur2 <- capbesfi |> filter(DATE == max(DATE), Composante == "Sociétés non financières") |> pull(value) |>
  round(digits = 1)
valeur3 <- capbesfi |> filter(DATE == max(DATE), Composante == "Ménages") |> pull(value) |>
  round(digits = 1)
valeur4 <- capbesfi |> filter(DATE == max(DATE), Composante == "APU") |> pull(value) |>
  round(digits = 1)

plot_capbesfi <-  ggplot(data=capbesfi, aes(x=DATE, y=value, fill=forcats::fct_relevel(Composante, c("Ménages", 
                                                                                                     'Sociétés financières',
                                                                                                     "Sociétés non financières", 
                                                                                                     "ISBLSM", 
                                                                                                     "APU" )))) +
  geom_col()+
  geom_line(aes(y = capbesfi_total_pib, color =  "Total vis-à-vis du reste du monde"), linewidth = 1.3) +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  labs(title = "Capacité (+) ou Besoin (-) de financement de l'économie française vis à vis du reste du monde", 
       
             subtitle = paste0("Lecture: Au ", date_def_litt, ", l'économie française est en ", ifelse(valeur>0, "capacité", "besoin"), " de  financement vis à vis du reste du monde à hauteur de ", valeur, " % du PIB. \nLes ménages sont en ", ifelse(valeur3>0, "capacité", "besoin"), " de financement (", valeur3, " %), les sociétés non financières en ", ifelse(valeur2>0, "capacité", "besoin"), " de financement (", valeur2, " %) et les APU en ",ifelse(valeur4>0, "capacité", "besoin"), " de financement (", valeur4, " %).\nSource : Insee - Comptes nationaux trimestriels (Résultats détaillés du ", date_def_litt,"). \nCalculs et graphiques : @statjunior"),
       
      
       y = "% du PIB nominal", x = "Trimestre") +
  theme_ipsum( plot_margin = margin(0, 0, 0, 0),
               plot_title_size = 16,
               #subtitle_size = 9.5,
               base_size = 12,
               axis_title_size = 11,
               axis_text_size = 12,
               base_family = "Helvetica")  +
  theme(
        legend.position="bottom",
        plot.title.position ="plot",
        axis.text.x = element_text(angle = 90),
        legend.title = element_text(size=10), 
        legend.text = element_text(size=12),
        plot.title = element_text(color = "#333333", size = 16, face = "bold"),
        plot.subtitle = element_text(color = "#333333", face = "italic"),
        axis.title.x = element_text(hjust = 0.5),  # Centre le titre de l'axe x
        axis.title.y = element_text(hjust = 0.5))+
  scale_colour_manual(values = c("Total vis-à-vis du reste du monde" = "blue")) + 
  scale_x_date(limits = as.Date(c("2000-01-01", NA))) +
  scale_fill_discrete(name = "Contribution", breaks=c("Ménages", 
                                                      'Sociétés financières',
                                                      "Sociétés non financières", 
                                                      "ISBLSM", 
                                                      "APU" ))+
  #scale_color_manual(values=c("#F8766D","#C77CFF", "#00BA38", "#D39200", "#00B8E7"))+
  ylim(-18,18) 
plot_capbesfi

```